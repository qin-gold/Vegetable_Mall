<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>结账页面</title>
  <!-- JqueryUI -->
  <link rel="stylesheet" type="text/css" href="/css/jquery-ui.css">
  <!-- Bootstrap -->
  <link rel="stylesheet" type="text/css" href="/css/bootstrap.min.css">
  <!-- Awesome font icons -->
  <link rel="stylesheet" type="text/css" href="/css/font-awesome.min.css" media="screen">
  <!-- Owlcoursel -->
  <link rel="stylesheet" type="text/css" href="/css/owl-coursel/owl.carousel.css">
  <link rel="stylesheet" type="text/css" href="/css/owl-coursel/owl.transitions.css">
  <!-- Magnific-popup -->
  <link rel="stylesheet" type="text/css" href="/css/magnific-popup/magnific-popup.css">
  <!-- Magnific-popup -->
  <link rel="stylesheet" type="text/css" href="/css/magnific-popup/magnific-popup.css">
  <!-- Style -->
  <link rel="stylesheet" type="text/css" href="/css/style.css" media="screen">
  <!-- Fw -->
  <link rel="stylesheet" type="text/css" href="/css/fw.css" media="screen">
</head>
<body>
<div class="preloader">
  <i class="fa fa-spinner"></i>
</div>
<header th:insert="templates/head :: header"></header>
<div class="heading-inner-page">
  <div class="container">
    <h2>结账页面</h2>
    <ul class="breadcrumb">
      <li><a href="/index">首页</a></li>
      <li>结账页面</li>
    </ul>
  </div>
</div>
<!-- Product -->
<section class="m-t-30">
  <div class="container">
    <div class="row">
      <section>
        <div class="container">
          <div id="content">
            <div class="panel-group">
              <!--设置用户名-->
              <div class="panel panel-default">
                <div class="panel-heading">
                  <h4 class="panel-title">
                    <a href="#collapse0" data-toggle="collapse" data-parent="#accordion"
                       class="accordion-toggle collapsed" aria-expanded="false">步骤1:设置收货人姓名
                      <i class="fa fa-caret-down"></i>
                    </a>
                  </h4>
                </div>
                <div id="collapse0" class="panel-collapse collapse in" role="tabpanel">
                  <div class="panel-body">
                    <form class="form-horizontal">
                      <div class="radio">
                        <label>
                          <input type="radio" name="payment_address" value="existing" class="oldUsername"
                                 checked="checked">
                          使用现存的用户名设置为收货人
                        </label>
                      </div>
                      <div>
                        <option th:text="${user.u_name}"></option>
                      </div>
                      <div class="radio">
                        <label>
                          <input type="radio" name="payment_address" value="new" class="username">
                          重新设置收货人
                        </label>
                      </div>
                      <p>
                        <input type="text" name="comment" rows="8" class=" newUsername form-control"/>
                      </p>
                    </form>
                  </div>
                </div>
              </div>
              <!--设置收货地址-->
              <div class="panel panel-default">
                <div class="panel-heading">
                  <h4 class="panel-title">
                    <a href="#collapse1" data-toggle="collapse" data-parent="#accordion"
                       class="accordion-toggle collapsed" aria-expanded="false">步骤2:设置收货地址
                      <i class="fa fa-caret-down"></i>
                    </a>
                  </h4>
                </div>
                <div id="collapse1" class="panel-collapse collapse" role="tabpanel">
                  <div class="panel-body">
                    <form class="form-horizontal">
                      <div class="radio">
                        <label>
                          <input type="radio" name="payment_address" class="oldAddress" checked="checked"/>
                          使用现存的收货地址
                        </label>
                      </div>
                      <div>
                        <option th:text="${user.address}"></option>
                      </div>
                      <div class="radio">
                        <label>
                          <input type="radio" name="payment_address" class="address">
                          新建一个收货地址
                        </label>
                      </div>
                      <p>
                        <textarea name="comment" rows="8" class="newAddress form-control"></textarea>
                      </p>
                    </form>
                  </div>
                </div>
              </div>
              <!--设置收货人电话号码-->
              <div class="panel panel-default">
                <div class="panel-heading">
                  <h4 class="panel-title">
                    <a href="#collapse2" data-toggle="collapse" data-parent="#accordion"
                       class="accordion-toggle collapsed" aria-expanded="false">步骤3:设置收货人电话号码
                      <i class="fa fa-caret-down"></i>
                    </a>
                  </h4>
                </div>
                <div id="collapse2" class="panel-collapse collapse" role="tabpanel">
                  <div class="panel-body">
                    <form class="form-horizontal">
                      <div class="radio">
                        <label>
                          <input type="radio" name="payment_address" class="oldNumber" checked="checked"/>
                          使用现存的电话号码
                        </label>
                      </div>
                      <div>
                        <option th:text="${user.phone}"></option>
                      </div>
                      <div class="radio2">
                        <label>
                          <input type="radio" name="payment_address" class="number">
                          重新设置新的电话号码
                        </label>
                      </div>
                      <p>
                        <input name="comment" rows="8" class="newNumber form-control"/>
                      </p>
                    </form>
                  </div>
                </div>
              </div>
              <!--设置备注-->
              <div class="panel panel-default">
                <div class="panel-heading">
                  <h4 class="panel-title">
                    <a href="#collapse3" data-toggle="collapse" data-parent="#accordion"
                       class="accordion-toggle collapsed" aria-expanded="false">步骤4:设置备注
                      <i class="fa fa-caret-down"></i>
                    </a>
                  </h4>
                </div>
                <div id="collapse3" class="panel-collapse collapse" role="tabpanel">
                  <div class="panel-body">
                    <form class="form-horizontal">
                      <div class="radio3">
                        <label>
                          备注
                        </label>
                      </div>
                      <p>
                        <textarea name="comment" rows="8" class="form-control"></textarea>
                      </p>
                    </form>
                  </div>
                </div>
              </div>
              <!--查看商品-->
              <div class="panel panel-default">
                <div class="panel-heading">
                  <h4 class="panel-title"><a href="#collapse4" data-toggle="collapse" data-parent="#accordion"
                                             class="accordion-toggle collapsed" aria-expanded="false">步骤5:检查确认购买的商品
                    <i class="fa fa-caret-down"></i></a></h4>
                </div>
                <div id="collapse4" class="panel-collapse collapse" role="tabpanel">
                  <table style="border-collapse: collapse;" border="1" class="table table-bordered table-hover">
                    <tr class="success">
                      <th style="text-align: center">商品名称</th>
                      <th style="text-align: center">单价</th>
                      <th style="text-align: center">数量</th>
                      <th style="text-align: center">小计</th>
                    </tr>
                    <tr th:each="cart:${product}" style="text-align: center">
                      <td id="p_id" th:text="${cart.p_id}" hidden></td>
                      <td th:text="${cart.product.p_name}" style="vertical-align:middle"></td>
                      <td th:text="${cart.product.p_price}" th:value="${cart.p_id}" style="vertical-align:middle"
                          class="price"></td>
                      <td th:text="${cart.p_count}" th:value="${cart.p_id}" style="vertical-align:middle"
                          class="count"></td>
                      <td class="subtotal" th:value="${cart.p_id}" style="vertical-align:middle"></td>
                    </tr>
                    <tr style="text-align: center">
                      <td colspan="2" style="font-size: 25px; ">总价</td>
                      <td colspan="2" id="total" style="font-size: 25px;width: 150px">0</td>
                    </tr>
                  </table>
                </div>
              </div>
              <div style="float: right">
                <h3 class="total"></h3>
                <button class="btn btn-danger submitButton" style="text-align: center;width: 100px;height: 50px">提交订单
                </button>
              </div>
            </div>
          </div>
        </div>
      </section>
    </div>
  </div>
</section>

<footer th:insert="templates/footer :: footers"></footer>
<!-- jQuery -->
<script src="/js/jquery/jquery-2.2.4.min.js"></script>
<!-- JqueryUI -->
<script src="/js/jquery/jquery-ui.js"></script>
<!-- Bootstrap -->
<script src="/js/bootstrap/bootstrap.min.js"></script>
<!-- Owl-coursel -->
<script src="/js/owl-coursel/owl.carousel.js"></script>
<!-- Magnific-popup -->
<script src="/js/magnific-popup/jquery.magnific-popup.min.js"></script>
<!-- Script -->
<script src="/js/script.js"></script>
<script src="/js/alter.js"></script>
<link rel="stylesheet" type="text/css" href="/js/layui/css/layui.css" media="screen">
<script src="/js/layui/layui.all.js"></script>
<script>
  let layer = layui.layer;
  let username = null;
  let address = null;
  let telephone = null;
  let totalNumber = null;

  $(function () {
    calcSubtotal()
    calcCartSumPriceAndNumber()
    $(".username").on('click', function () {
      $(".newUsername").on('blur', function () {
        username = $(".newUsername").val();
        console.log(username)
      })
    })
    $(".oldUsername").on('click', function () {
      username = null;
      console.log(username)
    })
    $(".address").on('click', function () {
      $(".newAddress").on('blur', function () {
        address = $(".newAddress").val();
        console.log(address)
      })
    })
    $(".oldAddress").on('click', function () {
      address = null;
      console.log(address)
    })
    $(".number").on('click', function () {
      $(".newNumber").on('blur', function () {
        telephone = $(".newNumber").val();
        console.log(telephone)
      })
    })
    $(".oldNumber").on('click', function () {
      telephone = null;
      console.log(telephone)
    })
  })

  $(".submitButton").on('click', function () {
    var params = "";
    $(".price").each(function () {
      let orderItemId = $(this).attr("value");
      params += "&p_id=" + orderItemId;
    });
    if (params == "" || params == null || params == undefined) {
      layer.alert("您未勾选任何商品")
      return;
    }
    params = params.substring(1);
    $.post("/loginBefore/createOrders?" + params, {
      totalmoney: totalNumber,
      address: address,
      telephone: telephone,
      username: username
    }, function (data) {
      if (data === null) {
        layer.alert("生成订单失败");
      }
      if (data.stateCode === 200) {
        layer.alert("生成订单成功正在跳转支付页面")
        console.log(data.data)
        window.location.href = '/loginBefore/payFor?o_id=' + data.data;
      } else {
        layer.alert("生成订单失败");
      }
    }, "json")
  })

  function calcCartSumPriceAndNumber() {
    $(".price").each(function () {
      let orderItemId = $(this).attr("value");
      let price = $(".subtotal[value=" + orderItemId + "]").text();
      price = price.replace(/,/g, "");
      price = price.replace(/￥/g, "");
      totalNumber += new Number(price);
    });
    $("#total").html("￥" + formatMoney(totalNumber));
    $(".total").html("￥" + formatMoney(totalNumber));
  }

  function calcSubtotal() {
    let subtotal = null;
    $(".price").each(function () {
      let orderItemId = $(this).attr("value");
      let price = $(".price[value=" + orderItemId + "]").text();
      let count = $(".count[value=" + orderItemId + "]").text();
      subtotal = price * count;
      subtotal = new Number(subtotal);
      $(".subtotal[value=" + orderItemId + "]").html("￥" + formatMoney(subtotal));
    })
  }

  function formatMoney(num) {
    num = num.toString().replace(/\$|\,/g, '');
    if (isNaN(num))
      num = "0";
    sign = (num == (num = Math.abs(num)));
    num = Math.floor(num * 100 + 0.50000000001);
    cents = num % 100;
    num = Math.floor(num / 100).toString();
    if (cents < 10)
      cents = "0" + cents;
    for (var i = 0; i < Math.floor((num.length - (1 + i)) / 3); i++)
      num = num.substring(0, num.length - (4 * i + 3)) + ',' +
          num.substring(num.length - (4 * i + 3));
    return (((sign) ? '' : '-') + num + '.' + cents);
  }

  $(".search").on('click', function () {
    var val = $(".form-item").val();
    var str = val.replace(/(^\s*)|(\s*$)/g, '')
    if (str === null || str === '') {
      layer.alert("请输入你要搜索的信息")
    } else {
      console.log(val)
      window.location.href = "/search?text=" + str
    }
  })
</script>
</body>
</html>

`